steps:
  # 1. Enable Required APIs on Target Project
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Enable APIs on Target'
    args:
      - '--project=${_TARGET_PROJECT_ID}'
      - services
      - enable
      - cloudfunctions.googleapis.com
      - pubsub.googleapis.com
      - cloudbilling.googleapis.com
      - eventarc.googleapis.com

  # 2. Enable Required APIs on Build Project
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Enable APIs on Build Project'
    args:
      - '--project=${PROJECT_ID}' # PROJECT_ID is a default substitution
      - services
      - enable
      - billingbudgets.googleapis.com

  # 3. Create Pub/Sub Topic if it doesn't exist
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Create Topic'
    entrypoint: 'bash'
    args:
      - -c
      - |
        if ! gcloud pubsub topics describe budget-alert-topic --project=${_TARGET_PROJECT_ID} --quiet; then
          echo "Topic 'budget-alert-topic' not found. Creating it now."
          gcloud pubsub topics create budget-alert-topic --project=${_TARGET_PROJECT_ID}
        else
          echo "Topic 'budget-alert-topic' already exists. Skipping creation."
        fi

  # 4. Deploy Cloud Function (creates or updates)
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Deploy Function'
    args:
      - functions
      - deploy
      - billing-disable-function
      - --project
      - '${_TARGET_PROJECT_ID}'
      - --region
      - 'us-central1'
      - --runtime
      - 'python311'
      - --entry-point
      - 'stop_billing'
      - --source
      - './function-source'
      - --trigger-topic
      - 'budget-alert-topic'
      - --set-env-vars
      - 'TARGET_PROJECT_ID=${_TARGET_PROJECT_ID}'

  # 5. Grant Billing Permissions and Create Budget if it doesn't exist
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Setup IAM and Budget'
    entrypoint: 'bash'
    args:
      - -c
      - |
        SERVICE_ACCOUNT=$(gcloud functions describe billing-disable-function \
          --project=${_TARGET_PROJECT_ID} \
          --region=us-central1 \
          --format='value(serviceAccountEmail)')
        
        echo "Granting Cloud Function's service account (${SERVICE_ACCOUNT}) the Project Billing Manager role on project ${_TARGET_PROJECT_ID}"
        gcloud projects add-iam-policy-binding ${_TARGET_PROJECT_ID} \
          --member="serviceAccount:${SERVICE_ACCOUNT}" \
          --role="roles/billing.projectManager" --quiet

        BUDGET_DISPLAY_NAME="${_TARGET_PROJECT_ID}-HARD-STOP-${_BUDGET_AMOUNT}"
        if gcloud beta billing budgets list --billing-account=${_BILLING_ACCOUNT_ID} --format="value(displayName)" | grep -q "^$${BUDGET_DISPLAY_NAME}$"; then
          echo "Budget '$${BUDGET_DISPLAY_NAME}' already exists. Skipping creation."
        else
          echo "Creating budget of ${_BUDGET_AMOUNT} for project ${_TARGET_PROJECT_ID} with multiple thresholds."
          gcloud beta billing budgets create \
            --billing-account=${_BILLING_ACCOUNT_ID} \
            --display-name="$${BUDGET_DISPLAY_NAME}" \
            --budget-amount=${_BUDGET_AMOUNT} \
            --filter-projects="projects/${_TARGET_PROJECT_ID}" \
            --credit-types-treatment=INCLUDE_ALL_CREDITS \
            --all-updates-rule-pubsub-topic="projects/${_TARGET_PROJECT_ID}/topics/budget-alert-topic" \
            --threshold-rule=percent=0.9 \
            --threshold-rule=percent=0.95 \
            --threshold-rule=percent=0.99
        fi
options:
  logging: CLOUD_LOGGING_ONLY
