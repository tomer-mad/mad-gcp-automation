steps:
# 1. Enable Required APIs (Always good practice for a setup script)
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Enable APIs'
  args:
    - services
    - enable
    - cloudfunctions.googleapis.com
    - pubsub.googleapis.com
    - cloudbilling.googleapis.com
  # Note: This runs within the target project context established by the gcloud service account.

# 2. Get Billing Account ID for the target project
# FIX: Extract the raw ID in one clean line to avoid parser conflicts.
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Get Billing ID'
  entrypoint: 'bash'
  args:
    - -c
    - |
      # Retrieve the full billing account name and strip the 'billingAccounts/' prefix.
      BILLING_ACCOUNT_ID=$(gcloud projects describe ${_TARGET_PROJECT_ID} --format='value(billingAccountName)' | sed 's|billingAccounts/||g')
      
      # Save the result as an environment variable for subsequent steps (Step 5)
      echo "export BILLING_ACCOUNT_ID=${BILLING_ACCOUNT_ID}" > /workspace/env_vars
      echo "Retrieved Billing Account ID: ${BILLING_ACCOUNT_ID}"
  # The output is saved to a file for subsequent steps to use

# 3. Create Pub/Sub Topic (uses the target project)
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Create Topic'
  args:
    - pubsub
    - topics
    - create
    - budget-alert-topic
  # Note: The project context is implied via the service account running the build.

# 4. Deploy Cloud Function (Uses the project ID substitution variable)
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Deploy Function'
  args:
    - functions
    - deploy
    - billing-disable-function
    - --project
    - '${_TARGET_PROJECT_ID}'
    - --region
    - 'us-central1' # Use your preferred region
    - --runtime
    - 'python311'
    - --entry-point
    - 'stop_billing'
    - --source
    - './function-source' # Directory containing main.py and requirements.txt
    - --trigger-topic
    - 'budget-alert-topic'
    - --set-env-vars
    - 'TARGET_PROJECT_ID=${_TARGET_PROJECT_ID}'

# 5. Grant Billing Permissions and Create Budget
# FIX: All BILLING_ACCOUNT_ID references are masked with $$ to prevent parser errors.
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Setup IAM and Budget'
  entrypoint: 'bash'
  args:
    - -c
    - |
      source /workspace/env_vars # Load the BILLING_ACCOUNT_ID
      
      # 5a. Get Function Service Account
      SERVICE_ACCOUNT=$(gcloud functions describe billing-disable-function \
        --project=${_TARGET_PROJECT_ID} \
        --region=us-central1 \
        --format='value(serviceAccountEmail)')
        
      # 5b. Grant Project Billing Manager role to the function's SA on the Billing Account
      echo "Granting billing permission to ${SERVICE_ACCOUNT} on $${BILLING_ACCOUNT_ID}"
      gcloud organizations add-iam-policy-binding $${BILLING_ACCOUNT_ID} \
        --member="serviceAccount:${SERVICE_ACCOUNT}" \
        --role="roles/billing.projectManager" \
        --account-id=$${BILLING_ACCOUNT_ID}
        
      # 5c. Create Budget
      echo "Creating budget of $${_BUDGET_AMOUNT} USD"
      gcloud beta billing budgets create \
        --billing-account=$${BILLING_ACCOUNT_ID} \
        --display-name="${_TARGET_PROJECT_ID}-HARD-STOP-$${_BUDGET_AMOUNT}" \
        --amount="$${_BUDGET_AMOUNT}" \
        --calendar-period=MONTH \
        --projects=${_TARGET_PROJECT_ID} \
        --threshold-rule=percent=100.0,action=pubsub,topic=budget-alert-topic,project=${_TARGET_PROJECT_ID} \
        --all-services