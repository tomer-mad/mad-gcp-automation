steps:
  # 1. Enable Required APIs
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Enable APIs'
    args:
      - '--project=${_TARGET_PROJECT_ID}'
      - services
      - enable
      - cloudfunctions.googleapis.com
      - pubsub.googleapis.com
      - cloudbilling.googleapis.com

  # 2. Create Pub/Sub Topic
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Create Topic'
    args:
      - '--project=${_TARGET_PROJECT_ID}'
      - pubsub
      - topics
      - create
      - budget-alert-topic

  # 3. Deploy Cloud Function
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Deploy Function'
    args:
      - functions
      - deploy
      - billing-disable-function
      - --project
      - '${_TARGET_PROJECT_ID}'
      - --region
      - 'us-central1'
      - --runtime
      - 'python311'
      - --entry-point
      - 'stop_billing'
      - --source
      - './function-source'
      - --trigger-topic
      - 'budget-alert-topic'
      - --set-env-vars
      - 'TARGET_PROJECT_ID=${_TARGET_PROJECT_ID}'

  # 4. Grant Billing Permissions and Create Budget
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Setup IAM and Budget'
    entrypoint: 'bash'
    args:
      - -c
      - |
        # Get the service account of the deployed Cloud Function.
        SERVICE_ACCOUNT=$(gcloud functions describe billing-disable-function \
          --project=${_TARGET_PROJECT_ID} \
          --region=us-central1 \
          --format='value(serviceAccountEmail)')

        # Grant the function's service account the 'billing.projectManager' role on the billing account.
        echo "Granting billing permission to ${SERVICE_ACCOUNT} on billing account ${_BILLING_ACCOUNT_ID}"
        gcloud billing accounts add-iam-policy-binding ${_BILLING_ACCOUNT_ID} \
          --member="serviceAccount:${SERVICE_ACCOUNT}" \
          --role="roles/billing.projectManager"

        # Create the budget for the target project.
        echo "Creating budget of ${_BUDGET_AMOUNT} USD for project ${_TARGET_PROJECT_ID}"
        gcloud beta billing budgets create \
          --billing-account=${_BILLING_ACCOUNT_ID} \
          --display-name="${_TARGET_PROJECT_ID}-HARD-STOP-${_BUDGET_AMOUNT}" \
          --budget-amount=${_BUDGET_AMOUNT} \
          --all-services \
          --credit-types-treatment=INCLUDE_ALL_CREDITS \
          --project=${_TARGET_PROJECT_ID} \
          --threshold-rule=percent=100.0,action=pubsub,topic=projects/${_TARGET_PROJECT_ID}/topics/budget-alert-topic
options:
  logging: CLOUD_LOGGING_ONLY
